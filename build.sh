#!/bin/bash

set -e

# ะฆะฒะตัะฐ ะดะปั ะฒัะฒะพะดะฐ
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

APP_NAME="Dictum"
BUNDLE_ID="com.dictum.app"

# ะงะธัะฐะตะผ ะฒะตััะธั ะธะท Info.plist (ะตะดะธะฝััะฒะตะฝะฝัะน ะธััะพัะฝะธะบ ะฟัะฐะฒะดั)
VERSION=$(/usr/libexec/PlistBuddy -c "Print :CFBundleShortVersionString" Info.plist 2>/dev/null || echo "1.0")
BUILD=$(/usr/libexec/PlistBuddy -c "Print :CFBundleVersion" Info.plist 2>/dev/null || echo "1")

echo -e "${BLUE}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
echo -e "${BLUE}๐จ ะกะฑะพัะบะฐ $APP_NAME v$VERSION (Xcode + FluidAudio)${NC}"
echo -e "${BLUE}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
echo ""

# ============================================================
# ะคะะะ 0: PRE-BUILD CLEANUP
# ============================================================
echo -e "${YELLOW}๐ฆ ะคะฐะทะฐ 0: ะะพะดะณะพัะพะฒะบะฐ ะบ ัะฑะพัะบะต${NC}"
echo ""

# 0.1 ะะฐะบััะฒะฐะตะผ ัะฐะฑะพัะฐััะตะต ะฟัะธะปะพะถะตะฝะธะต
echo -e "   โ ะะฐะบััะฒะฐะตะผ ะทะฐะฟััะตะฝะฝะพะต ะฟัะธะปะพะถะตะฝะธะต..."
if pgrep -x "$APP_NAME" > /dev/null; then
    killall "$APP_NAME" 2>/dev/null || true
    sleep 1

    # ะัะพะฒะตััะตะผ, ะทะฐะบััะปะพัั ะปะธ
    if pgrep -x "$APP_NAME" > /dev/null; then
        echo -e "${YELLOW}      โ ะัะธะปะพะถะตะฝะธะต ะฝะต ะพัะฒะตัะฐะตั, ะฟัะธะฝัะดะธัะตะปัะฝะพะต ะทะฐะฒะตััะตะฝะธะต...${NC}"
        killall -9 "$APP_NAME" 2>/dev/null || true
        sleep 1
    fi

    # ะคะธะฝะฐะปัะฝะฐั ะฟัะพะฒะตัะบะฐ
    if pgrep -x "$APP_NAME" > /dev/null; then
        echo -e "${RED}      โ ะะต ัะดะฐะปะพัั ะทะฐะบัััั ะฟัะธะปะพะถะตะฝะธะต!${NC}"
        echo -e "${YELLOW}      ะะฐะบัะพะนัะต ะฒัััะฝัั ะธ ะทะฐะฟัััะธัะต ัะฝะพะฒะฐ${NC}"
        exit 1
    fi

    echo -e "${GREEN}      โ ะัะธะปะพะถะตะฝะธะต ะทะฐะบัััะพ${NC}"
else
    echo -e "${GREEN}      โ ะัะธะปะพะถะตะฝะธะต ะฝะต ะฑัะปะพ ะทะฐะฟััะตะฝะพ${NC}"
fi

# 0.2 ะัะธัะฐะตะผ ะะกะ TCC permissions ะดะปั ัะธััะพะน ัะฑะพัะบะธ
echo -e "   โ ะัะธัะฐะตะผ ัะฐะทัะตัะตะฝะธั ัะธััะตะผั (TCC)..."

# ะกะฑัะฐััะฒะฐะตะผ ะะกะ ัะฐะทัะตัะตะฝะธั (tccutil ะฝะต ััะตะฑัะตั sudo ะดะปั bundle ID)
tccutil reset Microphone "$BUNDLE_ID" 2>/dev/null || true
tccutil reset ScreenCapture "$BUNDLE_ID" 2>/dev/null || true
tccutil reset Accessibility "$BUNDLE_ID" 2>/dev/null || true
echo -e "${GREEN}      โ ะัะต TCC ัะฐะทัะตัะตะฝะธั ัะฑัะพัะตะฝั (Microphone, ScreenCapture, Accessibility)${NC}"

# 0.3 ะัะธัะฐะตะผ ะฟัะตะดัะดัััั ัะฑะพัะบั
echo -e "   โ ะฃะดะฐะปัะตะผ ะฟัะตะดัะดัััั ัะฑะพัะบั..."
rm -rf "$APP_NAME.app"
rm -rf build/
echo -e "${GREEN}      โ ะกัะฐัะฐั ัะฑะพัะบะฐ ัะดะฐะปะตะฝะฐ${NC}"

echo ""
echo -e "${BLUE}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
echo ""

# ============================================================
# ะคะะะ 1: ะะะะะะะะ XCODE
# ============================================================
echo -e "${YELLOW}๐ ะคะฐะทะฐ 1: ะัะพะฒะตัะบะฐ Xcode${NC}"
echo ""

# ะัะพะฒะตััะตะผ xcode-select
XCODE_PATH=$(xcode-select -p 2>/dev/null || echo "")
if [[ "$XCODE_PATH" == "/Library/Developer/CommandLineTools" ]]; then
    echo -e "${RED}โ xcode-select ัะบะฐะทัะฒะฐะตั ะฝะฐ Command Line Tools${NC}"
    echo -e "${YELLOW}   ะัะฟะพะปะฝะธัะต:${NC}"
    echo -e "   ${BLUE}sudo xcode-select -s /Applications/Xcode.app/Contents/Developer${NC}"
    exit 1
fi

echo -e "${GREEN}      โ Xcode: $XCODE_PATH${NC}"

# ะัะพะฒะตััะตะผ ะฝะฐะปะธัะธะต project.yml ะดะปั xcodegen
if [ ! -f "project.yml" ]; then
    echo -e "${RED}โ ะะต ะฝะฐะนะดะตะฝ project.yml${NC}"
    exit 1
fi

# ะะตะฝะตัะธััะตะผ/ะพะฑะฝะพะฒะปัะตะผ Xcode ะฟัะพะตะบั
echo -e "   โ ะะตะฝะตัะธััะตะผ Xcode ะฟัะพะตะบั..."
if command -v xcodegen &> /dev/null; then
    xcodegen generate --use-cache
    echo -e "${GREEN}      โ Xcode ะฟัะพะตะบั ัะณะตะฝะตัะธัะพะฒะฐะฝ${NC}"
else
    echo -e "${YELLOW}      โ xcodegen ะฝะต ัััะฐะฝะพะฒะปะตะฝ, ะธัะฟะพะปัะทัะตะผ ัััะตััะฒัััะธะน ะฟัะพะตะบั${NC}"
fi

echo ""

# ============================================================
# ะคะะะ 2: ะกะะะะะ ะงะะะะ XCODEBUILD
# ============================================================
echo -e "${YELLOW}โ๏ธ  ะคะฐะทะฐ 2: ะกะฑะพัะบะฐ ัะตัะตะท xcodebuild${NC}"
echo ""

# ะกะพะฑะธัะฐะตะผ Release ะฒะตััะธั
echo -e "   โ ะะพะผะฟะธะปััะธั (Release, arm64)..."
xcodebuild -project Dictum.xcodeproj \
    -scheme Dictum \
    -configuration Release \
    -derivedDataPath ./build \
    -quiet \
    build

if [ $? -ne 0 ]; then
    echo -e "${RED}โ ะัะธะฑะบะฐ ะบะพะผะฟะธะปััะธะธ${NC}"
    exit 1
fi

echo -e "${GREEN}      โ ะะพะผะฟะธะปััะธั ััะฟะตัะฝะฐ${NC}"

# ะะพะฟะธััะตะผ ะฟัะธะปะพะถะตะฝะธะต ะฒ ะบะพัะตะฝั ะฟัะพะตะบัะฐ
echo -e "   โ ะะพะฟะธััะตะผ ะฟัะธะปะพะถะตะฝะธะต..."
cp -r "./build/Build/Products/Release/$APP_NAME.app" ./
echo -e "${GREEN}      โ $APP_NAME.app ัะบะพะฟะธัะพะฒะฐะฝ${NC}"

echo ""

# ============================================================
# ะคะะะ 3: POST-BUILD SUMMARY
# ============================================================
echo -e "${BLUE}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
echo -e "${GREEN}โ ะกะฑะพัะบะฐ ะทะฐะฒะตััะตะฝะฐ ััะฟะตัะฝะพ!${NC}"
echo -e "${BLUE}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
echo ""

# ะะพะบะฐะทัะฒะฐะตะผ ัะฐะทะผะตั
APP_SIZE=$(du -sh "$APP_NAME.app" | cut -f1)
echo -e "${BLUE}๐ฆ ะะฐะทะผะตั ะฟัะธะปะพะถะตะฝะธั: $APP_SIZE${NC}"
echo -e "${BLUE}   (ะะพะดะตะปั Parakeet v3 ~600MB ะทะฐะณััะถะฐะตััั ะพัะดะตะปัะฝะพ ะฒ ~/.cache/fluidaudio/)${NC}"
echo ""

# ะะฟัะธะธ ะทะฐะฟััะบะฐ
echo -e "${YELLOW}๐ ะงัะพ ะดะฐะปััะต?${NC}"
echo ""
echo -e "   ${GREEN}1.${NC} ะะฐะฟัััะธัั ะธะท ัะตะบััะตะน ะฟะฐะฟะบะธ:"
echo -e "      ${BLUE}open $APP_NAME.app${NC}"
echo ""
echo -e "   ${GREEN}2.${NC} ะฃััะฐะฝะพะฒะธัั ะฒ /Applications (ัะตะบะพะผะตะฝะดัะตััั):"
echo -e "      ${BLUE}cp -r $APP_NAME.app /Applications/${NC}"
echo -e "      ${BLUE}open /Applications/$APP_NAME.app${NC}"
echo ""
echo -e "${RED}โ๏ธ  ะะะะะ: ะขัะตะฑััััั ัะฐะทัะตัะตะฝะธั ัะธััะตะผั${NC}"
echo ""
echo -e "   ะะพัะปะต ะทะฐะฟััะบะฐ ะฟัะตะดะพััะฐะฒััะต ัะฐะทัะตัะตะฝะธั ะฒ ะกะธััะตะผะฝัั ะฝะฐัััะพะนะบะฐั:"
echo -e "   โข ${YELLOW}ะฃะฝะธะฒะตััะฐะปัะฝัะน ะดะพัััะฟ${NC} (Accessibility) โ ะดะปั ะฒััะฐะฒะบะธ ัะตะบััะฐ"
echo -e "   โข ${YELLOW}ะะธะบัะพัะพะฝ${NC} (Microphone) โ ะดะปั ะทะฐะฟะธัะธ ะณะพะปะพัะฐ"
echo -e "   โข ${YELLOW}ะะฐะฟะธัั ัะบัะฐะฝะฐ${NC} (Screen Recording) โ ะดะปั ัะบัะธะฝัะพัะพะฒ"
echo ""
echo -e "${BLUE}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
