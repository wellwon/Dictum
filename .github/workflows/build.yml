name: Build

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  APP_NAME: Dictum

jobs:
  build:
    runs-on: macos-15  # Apple Silicon with Xcode 16+

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install xcodegen
        run: |
          brew install xcodegen
          xcodegen --version

      - name: Setup environment
        run: |
          echo "Building $APP_NAME..."
          sw_vers
          uname -m
          xcode-select -p
          xcodebuild -version

          # Generate Xcode project from project.yml
          xcodegen generate --use-cache
          echo "✅ Xcode project generated via xcodegen"

      - name: Build application (Release)
        run: |
          xcodebuild \
            -project Dictum.xcodeproj \
            -scheme Dictum \
            -configuration Release \
            -derivedDataPath ./build \
            -destination 'platform=macOS,arch=arm64' \
            -quiet \
            build

          # Verify build succeeded
          APP_PATH="./build/Build/Products/Release/Dictum.app"
          if [ ! -d "$APP_PATH" ]; then
            echo "❌ Build failed: Dictum.app not found at $APP_PATH"
            exit 1
          fi
          echo "✅ Build successful: $APP_PATH"

      - name: Verify app bundle
        run: |
          APP_PATH="./build/Build/Products/Release/Dictum.app"

          # Check essential bundle structure
          test -d "$APP_PATH/Contents" || exit 1
          test -f "$APP_PATH/Contents/MacOS/Dictum" || exit 1
          test -f "$APP_PATH/Contents/Info.plist" || exit 1

          # Get bundle info
          BUNDLE_ID=$(/usr/libexec/PlistBuddy -c "Print :CFBundleIdentifier" "$APP_PATH/Contents/Info.plist")
          VERSION=$(/usr/libexec/PlistBuddy -c "Print :CFBundleShortVersionString" "$APP_PATH/Contents/Info.plist")

          echo "Bundle ID: $BUNDLE_ID"
          echo "Version: $VERSION"
          echo "✅ App bundle structure verified"

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: Dictum-Release-arm64
          path: ./build/Build/Products/Release/Dictum.app
          if-no-files-found: error
          retention-days: 7
